<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
    <style type="text/css">
        
            div.bar {
                display: inline-block;
                width: 50px;
                height: 75px;   /* Gets overriden by D3-assigned height below */
                margin-right: 20px;
                background-color: teal;
            }
        
        </style>
    </head>
    <body>
    
    <p>Manifesto Classifier</p>
        Name: <input type="text" id="textBox" value="Sicherheit">

        <p>Click the button to change the value of the text field.</p>

        <button onclick="visualize()">Try it</button>
        <p id=result></p>
               <script type="text/javascript" src="d3.js"></script>
        <script type="text/javascript">
        var width = 300,
    height = 300,
    radius = Math.min(width, height) / 2,
    padding = 1;

    var circleWidth = 90;
    var outerRadius = width / 2;
    var innerRadius = outerRadius - circleWidth;
    var pie = d3.layout.pie().sort(null); 
    
    var domain = [
        "Economy",
        "External Relations",
        "Fabric of Society",
        "Freedom and Democracy",
        "Political System",
        "Welfare and Quality of Life"
    ];

    var leftright = ["left","right"]    
    var initialData = {"leftright":leftright,"domain":domain}

    var colors = {
                "leftright":function (i){c = ["#FF0000", "#100000"];return c[i]},
                "domain":d3.scale.category10()
                };

    var arcs = {
               
            "leftright":d3.svg.arc()
                    .innerRadius(0)
                    .outerRadius(innerRadius-padding),
            "domain":d3.svg.arc()
                    .innerRadius(innerRadius+padding)
                    .outerRadius(outerRadius)
                };
    
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
    
    setup();

    function uniformData(size) {
        return Array.apply(null, Array(size)).map(function(){return 1.0/size})
    }

    function obj2FieldsValues(obj) {
            var fields = Object.keys(obj)
            var vals = fields.map(function(key) {return obj[key]});
            return {fields:fields,values:vals}
    }
        
    function obj2Tuples(obj) {
        return Object.keys(obj).map(function (key) {return [key,obj[key]]});
    }

  
    
    function setup(){
        for (arc in arcs){
            data = uniformData(initialData[arc].length)
            labels = initialData[arc]
            svg.append("g").attr("class",arc)
                .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
            
            svg.selectAll("g."+arc).selectAll("path")
                .data(pie(data))
              .enter().append("path").attr("class", arc)
                .attr("fill", function(d, i) { return colors[arc](i); })
                .attr("d", arcs[arc])
                .each(function(d) { this._current = d; })       
                .append("svg:title")
                          .text(function(d,i){return tipString(labels[i],data[i]);})
     
        }
    }

    function tipString(txt,prediction){return txt+": "+ Math.round(prediction*100.0)/100;}

    // Store the currently-displayed angles in this._current.
    // Then, interpolate from this._current to the new angles.
    function arcTween(c,a,arcc) {
        var i = d3.interpolate(c, a);
        c = i(0);
        return function(t) {
            return arcc(i(t));
        };
    }
   
     function updateArc(text,arcid){
        data = obj2FieldsValues(text[arcid]).values
        labels = obj2FieldsValues(text[arcid]).fields
            //Clean groups and set up new groups
            svg.selectAll("path."+arcid)
                .data(pie(data))
                .transition().duration(750).attrTween("d", function(d){
                    return arcTween(this._current,d,arcs[arcid])})
                .select("title").text(function(d,i){return tipString(labels[i],data[i]);})
    }
    
    function visualize(){
        var queryText = document.getElementById("textBox").value
        d3.json("/api/predict")
            .header("Content-type", "application/x-www-form-urlencoded")
            .post("text="+queryText, function(error, currentPrediction) {
            for (arc in arcs){ updateArc(currentPrediction,arc);}
            })
    }

      
        </script>
    </body>
</html>
